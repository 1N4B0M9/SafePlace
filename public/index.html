<!DOCTYPE html>
<html>
  <head>
    <title>Report Hate Crime on Map</title>
    <style>
      /* map size */
      #map {
        height: 400px;
        width: 100%;
      }

      /* form style */
      #crime-form {
        display: none;
        margin-top: 10px;
      }
    </style>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlJzZPVSJwtk99JUKoshFwG8K96ppJHak&callback=initMap" async defer></script>
    <script>
      let map;
      let selectedLocation = null;

      function initMap() {
        
        const centerCoords = { lat: 40.4321, lng: -79.9585 }; // Default center (Oakland)

        // Map style
        const customMapStyle = [ 
          {
            "elementType": "geometry",
            "stylers": [{ "color": "#2d2d2d" }] // Background land color
          },
          {
            "elementType": "labels.text.fill",
            "stylers": [{ "color": "#000000" }] // Labels color using your specified hex
          },
          {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [{ "color": "#F1C40F" }] // Road color
          },
          {
            "featureType": "water",
            "elementType": "geometry.fill",
            "stylers": [{ "color": "#1d2c4d" }] // Water color
          },
          {
            "featureType": "poi.park",
            "elementType": "geometry",
            "stylers": [{ "color": "#383838" }] // Parks color
          }
        ];

        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 12,
          center: centerCoords,
          styles: customMapStyle,
          streetViewControl: false
        });
       // Fetch reports and plot markers
       fetch('/reports')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(reports => {
                    reports.forEach(report => {
                        const position = { lat: parseFloat(report.lat), lng: parseFloat(report.lng) };
                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: report.description // Tooltip on marker
                        });

                        // Create an InfoWindow for the marker
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div>
                                <strong>Description:</strong> ${report.description}<br>
                                <strong>Date:</strong> ${new Date(report.date).toLocaleDateString()}<br>
                                <strong>Category:</strong> ${report.category}<br>
                                <strong>Location:</strong> (${report.lat}, ${report.lng})
                            </div>`
                        });

                        // Add a click listener to the marker to open the InfoWindow
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching reports:', error);
                });
        // Listen for clicks on the map
        map.addListener("click", function(event) {
          if (selectedLocation) {
            selectedLocation.setMap(null); // Remove previous marker if it exists
          }

          // Place a new marker at the clicked location
          selectedLocation = new google.maps.Marker({
            position: event.latLng,
            map: map,
          });

          // Update hidden form fields with coordinates
          document.getElementById('lat').value = event.latLng.lat();
          document.getElementById('lng').value = event.latLng.lng();

          // Show the form
          document.getElementById('crime-form').style.display = 'block';
        });
      }
      function submitCrime() {
    const reportData = {
      description: document.getElementById('description').value,
      date: document.getElementById('date').value,
      category: document.getElementById('category').value,
      lat: document.getElementById('lat').value,
      lng: document.getElementById('lng').value,
    };

    fetch('/report', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(reportData),
    })
    .then(response => response.json())
    .then(data => {
      alert(data.message);
      // Reset the form and hide it
      document.getElementById('crime-form').reset();
      document.getElementById('crime-form').style.display = 'none';
      if (selectedLocation) {
        selectedLocation.setMap(null); // Remove marker after submission
        selectedLocation = null;
      }
    })
    .catch(error => {
      console.error('Error submitting report:', error);
    });
  }
  
    </script>
  </head>
  <body>
    <h3>Report Hate Crime</h3>
    <a href = "./reports.html"><h3>Reports</h3></a>
    <div id="map"></div>

    <!-- Form to report hate crime -->
    <div id="crime-form">
      <h4>Report Hate Crime at Selected Location</h4>
      <form onsubmit="event.preventDefault(); submitCrime();">
        <label for="description">Description:</label>
        <input type="text" id="description" name="description" required><br><br>

        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required><br><br>

        <label for="category">Category:</label>
        <select id="category" name="category" required>
          <option value="" disabled selected>Select a category</option>
          <option value="Race">Race</option>
          <option value="Religion">Religion</option>
          <option value="Gender Identity">Gender Identity</option>
          <option value="Sexual Orientation">Sexual Orientation</option>
          <option value="Ethnicity">Ethnicity</option>
          <option value="Disability">Disability</option>
        </select><br><br>

        <!-- Hidden fields to store coordinates -->
        <input type="hidden" id="lat" name="lat">
        <input type="hidden" id="lng" name="lng">

        <button type="submit">Submit Report</button>


      </form>

    </div>
  </body>
</html>